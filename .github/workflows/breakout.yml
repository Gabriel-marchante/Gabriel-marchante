name: Generate Breakout Animation

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Breakout SVG
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const distDir = path.join(process.cwd(), 'dist');
            if (!fs.existsSync(distDir)) {
              fs.mkdirSync(distDir, { recursive: true });
            }

            const query = `
              query($userName:String!) {
                user(login: $userName) {
                  contributionsCollection {
                    contributionCalendar {
                      weeks {
                        contributionDays {
                          contributionCount
                          date
                        }
                      }
                    }
                  }
                }
              }
            `;

            const variables = { userName: context.repo.owner };
            const result = await github.graphql(query, variables);
            const weeks = result.user.contributionsCollection.contributionCalendar.weeks;

            const svgContent = generateBreakoutSVG(weeks, false);
            const svgContentDark = generateBreakoutSVG(weeks, true);

            fs.writeFileSync(path.join(distDir, 'breakout-contribution-graph.svg'), svgContent);
            fs.writeFileSync(path.join(distDir, 'breakout-contribution-graph-dark.svg'), svgContentDark);

            console.log('âœ… SVG files generated successfully!');

            function generateBreakoutSVG(weeks, isDark) {
              const cellSize = 11;
              const cellGap = 2;
              const paddleWidth = 80;
              const paddleHeight = 10;
              const ballRadius = 5;
              
              const gridWidth = Math.min(weeks.length, 53);
              const width = gridWidth * (cellSize + cellGap) + 60;
              const height = 7 * (cellSize + cellGap) + 150;

              const bgColor = isDark ? '#0d1117' : '#ffffff';
              const textColor = isDark ? '#c9d1d9' : '#24292f';
              const borderColor = isDark ? '#30363d' : '#d0d7de';
              const level0 = isDark ? '#161b22' : '#ebedf0';
              const level1 = isDark ? '#0e4429' : '#9be9a8';
              const level2 = isDark ? '#006d32' : '#40c463';
              const level3 = isDark ? '#26a641' : '#30a14e';
              const level4 = isDark ? '#39d353' : '#216e39';
              const paddleColor = isDark ? '#58a6ff' : '#0969da';
              const ballColor = isDark ? '#f85149' : '#cf222e';
              const glowColor = isDark ? '#58a6ff' : '#0969da';

              let bricks = '';
              const recentWeeks = weeks.slice(-gridWidth);
              
              recentWeeks.forEach((week, weekIndex) => {
                week.contributionDays.forEach((day, dayIndex) => {
                  const x = weekIndex * (cellSize + cellGap) + 30;
                  const y = dayIndex * (cellSize + cellGap) + 30;
                  const count = day.contributionCount;
                  
                  let color = level0;
                  if (count > 0) color = level1;
                  if (count > 5) color = level2;
                  if (count > 10) color = level3;
                  if (count > 15) color = level4;

                  const animDelay = (weekIndex * 7 + dayIndex) * 0.05;
                  
                  bricks += `
                    <g>
                      <rect x="${x}" y="${y}" 
                            width="${cellSize}" height="${cellSize}" 
                            rx="2" fill="${color}" 
                            stroke="${borderColor}" stroke-width="0.5">
                        <animate attributeName="opacity"
                                 begin="${animDelay}s"
                                 dur="0.4s"
                                 values="1;0.3;0"
                                 fill="freeze"/>
                        <animateTransform attributeName="transform"
                                          type="scale"
                                          begin="${animDelay}s"
                                          dur="0.4s"
                                          values="1 1;1.2 1.2;0.8 0.8"
                                          additive="sum"
                                          fill="freeze"/>
                      </rect>
                      ${count > 10 ? `
                      <circle cx="${x + cellSize/2}" cy="${y + cellSize/2}" r="${cellSize/2 + 2}" 
                              fill="none" stroke="${glowColor}" stroke-width="1" opacity="0">
                        <animate attributeName="opacity"
                                 begin="${animDelay}s"
                                 dur="0.3s"
                                 values="0;0.6;0"
                                 fill="freeze"/>
                        <animate attributeName="r"
                                 begin="${animDelay}s"
                                 dur="0.3s"
                                 values="${cellSize/2};${cellSize/2 + 4};${cellSize/2 + 6}"
                                 fill="freeze"/>
                      </circle>` : ''}
                    </g>`;
                });
              });

              const paddleY = height - 60;
              const paddleStartX = 30;
              const paddleEndX = width - paddleWidth - 30;
              const ballStartX = 40;
              const ballStartY = paddleY - 15;

              const totalDuration = (gridWidth * 7 * 0.05) + 0.5;
              
              const generateBallPath = () => {
                let path = `M ${ballStartX} ${ballStartY}`;
                const bounces = 30;
                let currentX = ballStartX;
                let currentY = ballStartY;
                
                for (let i = 0; i < bounces; i++) {
                  const nextX = Math.min(currentX + (width - 60) / bounces, width - 40);
                  const peakY = 40 + Math.random() * 30;
                  const controlX = (currentX + nextX) / 2;
                  
                  path += ` Q ${controlX} ${peakY} ${nextX} ${paddleY - 15}`;
                  currentX = nextX;
                }
                
                return path;
              };

              return `<?xml version="1.0" encoding="UTF-8"?>
            <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                  <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
                <linearGradient id="paddleGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:${paddleColor};stop-opacity:1" />
                  <stop offset="100%" style="stop-color:${paddleColor};stop-opacity:0.7" />
                </linearGradient>
                <radialGradient id="ballGradient" cx="30%" cy="30%">
                  <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:${ballColor};stop-opacity:1" />
                </radialGradient>
              </defs>

              <rect width="100%" height="100%" fill="${bgColor}"/>
              
              <text x="${width/2}" y="18" 
                    font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" 
                    font-size="14" font-weight="600" fill="${textColor}" 
                    text-anchor="middle">
                ðŸŽ® Breakout Contributions
              </text>
              
              <rect x="10" y="10" width="${width - 20}" height="${height - 20}" 
                    rx="8" fill="none" stroke="${borderColor}" stroke-width="2" opacity="0.3"/>
              
              <g id="bricks">
                ${bricks}
              </g>

              <g id="paddle">
                <rect x="${paddleStartX}" y="${paddleY}" 
                      width="${paddleWidth}" height="${paddleHeight}" 
                      rx="5" fill="url(#paddleGradient)" filter="url(#glow)">
                  <animate attributeName="x"
                           dur="${totalDuration}s"
                           values="${paddleStartX};${paddleStartX + 50};${paddleStartX + 100};${paddleEndX - 100};${paddleEndX - 50};${paddleEndX};${paddleEndX - 50};${paddleStartX + 150};${paddleStartX + 80};${paddleStartX}"
                           repeatCount="indefinite"/>
                </rect>
                <rect x="${paddleStartX}" y="${paddleY}" 
                      width="${paddleWidth}" height="2" 
                      rx="1" fill="#ffffff" opacity="0.5">
                  <animate attributeName="x"
                           dur="${totalDuration}s"
                           values="${paddleStartX};${paddleStartX + 50};${paddleStartX + 100};${paddleEndX - 100};${paddleEndX - 50};${paddleEndX};${paddleEndX - 50};${paddleStartX + 150};${paddleStartX + 80};${paddleStartX}"
                           repeatCount="indefinite"/>
                </rect>
              </g>

              <g id="ball">
                <circle r="${ballRadius}" fill="url(#ballGradient)" filter="url(#glow)">
                  <animateMotion dur="${totalDuration}s" repeatCount="indefinite" path="${generateBallPath()}"/>
                  <animate attributeName="r"
                           dur="0.2s"
                           values="${ballRadius};${ballRadius + 1};${ballRadius}"
                           repeatCount="indefinite"/>
                </circle>
                <circle r="${ballRadius + 3}" fill="none" stroke="${ballColor}" stroke-width="1" opacity="0.3">
                  <animateMotion dur="${totalDuration}s" repeatCount="indefinite" path="${generateBallPath()}"/>
                  <animate attributeName="r"
                           dur="0.4s"
                           values="${ballRadius + 3};${ballRadius + 5};${ballRadius + 3}"
                           repeatCount="indefinite"/>
                  <animate attributeName="opacity"
                           dur="0.4s"
                           values="0.3;0.1;0.3"
                           repeatCount="indefinite"/>
                </circle>
              </g>

              <text x="${width/2}" y="${height - 15}" 
                    font-family="monospace" 
                    font-size="11" fill="${textColor}" 
                    text-anchor="middle" opacity="0.6">
                ${recentWeeks.reduce((sum, week) => sum + week.contributionDays.reduce((s, d) => s + d.contributionCount, 0), 0)} contributions destroyed ðŸ’¥
              </text>

            </svg>`;
            }

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: output
          force_orphan: true
